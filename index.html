<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8" />

  <title>Playground</title>

  <style type="text/css">
  </style>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
  <script src="https://unpkg.com/redux@3.6.0/dist/redux.min.js"></script>
</head>

<body>

  <script>
    (function(){
      var redirect = sessionStorage.redirect;
      delete sessionStorage.redirect;
      if (redirect && redirect != location.href) {
        history.replaceState(null, null, redirect);
      }
    })();
    
    var queryParams = location.search.slice(1).split('&').reduce(function(q,s){
      var [k, v] = s.split('=');
      var arrayParam = k.match(/^(.+)\[(\d*)\]/);
      if (arrayParam) {
        var [_match, arrayKey, arrayIndex] = arrayParam;
        if(!q[arrayKey]) q[arrayKey] = [];
        if (arrayIndex) q[arrayKey][arrayIndex] = v;
        else q[arrayKey].push(v);
      } else {
        q[k] = v;
      }
      return q;
    }, {});
    
    
    var actions = function(){
      return {
        peerOpen: peerId =>({ type: 'Peer open', peerId })
      };
    }();
    
    //var initialState = {
    //  //peerId: String,
    //  potentialPeers: [],
    //  peers: []
    //};
    function reducer(state, action){
      var r = {
        'Peer open': ()=>{
          var [peerId, ...potentialPeers] = state.potentialPeers;
          if (peerId){
            var connection = peer.connect(peerId);
            connection.on('data' , data => { store.dispatch(actions.connectionData(data)); });
            connection.on('open' , ()   => { store.dispatch(actions.connectionOpen()    ); });
            connection.on('close', ()   => { store.dispatch(actions.connectionClose()   ); });
            connection.on('error', ()   => { store.dispatch(actions.connectionError()   ); });
          }
          return Object.apply({}, state, { peerId: action.peerId, peers: [ action.peerId ], potentialPeers });
        }
      }[action.type];
      console.log('Action type: '+action.type, JSON.stringify(state, null, 4));
      if (r) return r();
      console.log('Unknown action type: '+action.type);
      return state;
    }
    var initialState = {
      peers: [],
      potentialPeers: queryParams.peers || []
    };
    console.log('initialState', JSON.stringify(initialState, null, 4));
    var store = Redux.createStore(reducer, initialState);
    var unsubscribeStore = store.subscribe(function(){
      var state = store.getState();
      console.log(JSON.stringify(state, null, 4));
      if (Object.keys(state).length === 0) return;
      var queryString = state.peers.map(p=>'peers[]='+p+'').join(',');
      history.replaceState(null, null, "/Playground/?"+queryString);
    });
        
    var peer = new Peer({key: 'p6zcgijuvfclq5mi'});
    peer.on('open'        , id         => { store.dispatch(actions.peerOpen(id)              ); });
    peer.on('connection'  , connection => { store.dispatch(actions.peerConnection(connection)); });
    peer.on('close'       , ()         => { store.dispatch(actions.peerClose()               ); });
    peer.on('disconnected', ()         => { store.dispatch(actions.peerDisconnected()        ); });
    peer.on('error'       , error      => { store.dispatch(actions.peerError(error)          ); });
  </script>

</body>


</html>
